name: Update GitHub Stats

on:
  push:
    branches:
      - master
      - main
  schedule:
    - cron: '0 */12 * * *' # every 12 hours
  workflow_dispatch:

permissions:
  contents: write


jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Generate GitHub stats
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const user = context.repo.owner;

            // Fetch user info
            const { data: profile } = await github.rest.users.getByUsername({ username: user });

            const joinedYear = new Date(profile.created_at).getFullYear();
            const years = new Date().getFullYear() - joinedYear;

            // GraphQL for contributions
            const query = `
              query($login:String!) {
                user(login:$login) {
                  contributionsCollection {
                    totalCommitContributions
                    totalIssueContributions
                    totalPullRequestContributions
                  }
                  repositories(privacy: PUBLIC, ownerAffiliations: OWNER, first: 100) {
                    nodes { stargazerCount }
                  }
                  repositoriesContributedTo(privacy: PUBLIC, first: 1) {
                    totalCount
                  }
                }
              }
            `;

            const result = await github.graphql(query, { login: user });

            const commits = result.user.contributionsCollection.totalCommitContributions;
            const issues = result.user.contributionsCollection.totalIssueContributions;
            const prs = result.user.contributionsCollection.totalPullRequestContributions;

            const stars = result.user.repositories.nodes
              .reduce((sum, r) => sum + r.stargazerCount, 0);

            const contributedRepos = result.user.repositoriesContributedTo.totalCount;

            const statsText = [
              `**GitHub snapshot** (since ${joinedYear})`,
              ``,
              `- **${years}** years on GitHub`,
              `- **${commits.toLocaleString()}** commits`,
              `- **${prs.toLocaleString()}** pull requests`,
              `- **${issues.toLocaleString()}** issues opened`,
              `- **${stars.toLocaleString()}** stars received (across my public repos)`,
              `- **${contributedRepos.toLocaleString()}** public repositories contributed to`,
            ].join("\n");

            const fs = require("fs");
            const readme = fs.readFileSync("README.md", "utf8");

            const updated = readme.replace(
              /<!-- GITHUB_STATS_START -->[\s\S]*?<!-- GITHUB_STATS_END -->/,
              `<!-- GITHUB_STATS_START -->\n${statsText}\n<!-- GITHUB_STATS_END -->`
            );

            fs.writeFileSync("README.md", updated);

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git commit -m "chore: update GitHub stats" || exit 0
          git push
